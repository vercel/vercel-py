name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  lint-test-and-build:
    name: lint-test-and-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Set up virtualenv (Python 3.12)
        run: uv venv --python 3.12

      - name: Install dependencies
        run: uv pip install -e .[dev]

      - name: Lint
        run: |
          uv run ruff format
          uv run ruff check --fix .
          uv run mypy src
          uv run python -c "import vercel, vercel.cache, vercel.headers, vercel.oidc"

      - name: Run tests
        run: uv run pytest -v

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Login to Vercel
        run: vercel login --token ${{ secrets.VERCEL_TOKEN }}

      - name: Link Project
        run: vercel link --yes --token ${{ secrets.VERCEL_TOKEN }}

      - name: Fetch OIDC Token
        id: oidc-token
        run: |
          # Pull environment variables to get OIDC token
          vercel env pull --token ${{ secrets.VERCEL_TOKEN }}
          
          # Extract OIDC token from .env.local
          if [ -f .env.local ]; then
            OIDC_TOKEN=$(grep "VERCEL_OIDC_TOKEN=" .env.local | cut -d'"' -f2)
            if [ -n "$OIDC_TOKEN" ]; then
              echo "oidc-token=$OIDC_TOKEN" >> $GITHUB_OUTPUT
              echo "✅ OIDC token fetched successfully"
              
              # Verify token is valid JWT
              if echo "$OIDC_TOKEN" | grep -q '^[A-Za-z0-9_-]*\.[A-Za-z0-9_-]*\.[A-Za-z0-9_-]*$'; then
                echo "✅ OIDC token is valid JWT format"
              else
                echo "⚠️  OIDC token may not be valid JWT format"
              fi
            else
              echo "❌ OIDC token is empty"
              echo "oidc-token=" >> $GITHUB_OUTPUT
            fi
          else
            echo "❌ Failed to fetch OIDC token - .env.local not found"
            echo "oidc-token=" >> $GITHUB_OUTPUT
          fi

      - name: Run E2E tests (if secrets available)
        env:
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
          VERCEL_OIDC_TOKEN: ${{ steps.oidc-token.outputs.oidc-token }}
        run: |
          echo "Running E2E tests with OIDC token..."
          echo "OIDC Token available: $([ -n "$VERCEL_OIDC_TOKEN" ] && echo "Yes" || echo "No")"
          uv run python run_e2e_tests.py --test-type e2e || echo "E2E tests skipped (secrets not available)"

      - name: Cleanup sensitive files
        if: always()
        run: |
          # Remove .env.local file containing OIDC token
          rm -f .env.local
          echo "✅ Cleaned up sensitive files"

      - name: Build package
        run: uv run python -m build
